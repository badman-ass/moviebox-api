name: CinemaHub V5 Diagnostic

on:
  workflow_dispatch:

permissions:
  contents: write

jobs:
  build:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout Repo
        uses: actions/checkout@v4

      - name: Setup Java
        uses: actions/setup-java@v4
        with:
          distribution: 'zulu'
          java-version: '17'

      - name: Setup Flutter
        uses: subosito/flutter-action@v2
        with:
          flutter-version: '3.19.0'

      - name: 1. Create Project
        run: |
          rm -rf cinemahub_flutter
          flutter create cinemahub_flutter --project-name cinemahub --org com.cinemahub

      - name: 2. Inject Internet Permissions
        run: |
          sed -i '/<application/i \    <uses-permission android:name="android.permission.INTERNET" />' cinemahub_flutter/android/app/src/main/AndroidManifest.xml
          sed -i 's/<application/<application android:usesCleartextTraffic="true"/' cinemahub_flutter/android/app/src/main/AndroidManifest.xml

      - name: 3. Diagnostic Movie Code
        run: |
          cat <<EOF > cinemahub_flutter/lib/main.dart
          import 'package:flutter/material.dart';
          import 'dart:convert';
          import 'package:http/http.dart' as http;

          void main() => runApp(const MaterialApp(debugShowCheckedModeBanner: false, home: MovieListScreen()));

          class MovieListScreen extends StatefulWidget {
            const MovieListScreen({super.key});
            @override
            State<MovieListScreen> createState() => _MovieListScreenState();
          }

          class _MovieListScreenState extends State<MovieListScreen> {
            List movies = [];
            bool isLoading = true;
            String logMessage = "Starting...";

            @override
            void initState() {
              super.initState();
              fetchMovies();
            }

            Future<void> fetchMovies() async {
              setState(() { isLoading = true; logMessage = "Trying main server..."; });
              
              // List of mirrors to try
              List<String> apis = [
                "https://yts.mx/api/v2/list_movies.json?limit=20",
                "https://yts.pm/api/v2/list_movies.json?limit=20",
              ];

              for (String url in apis) {
                try {
                  final response = await http.get(
                    Uri.parse(url),
                    headers: {
                      "User-Agent": "Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36",
                      "Accept": "application/json",
                    }
                  ).timeout(const Duration(seconds: 10));

                  if (response.statusCode == 200) {
                    final data = json.decode(response.body);
                    setState(() { movies = data['data']['movies'] ?? []; isLoading = false; });
                    return; // Stop if it works!
                  } else {
                    setState(() { logMessage = "Server Error: \${response.statusCode}"; });
                  }
                } catch (e) {
                  setState(() { logMessage = "Technical Error: \$e"; });
                }
              }
              setState(() { isLoading = false; });
            }

            @override
            Widget build(BuildContext context) {
              return Scaffold(
                backgroundColor: Colors.black,
                appBar: AppBar(title: const Text('CinemaHub Diagnostic'), backgroundColor: Colors.red),
                body: isLoading 
                  ? Center(child: Column(
                      mainAxisAlignment: MainAxisAlignment.center,
                      children: [const CircularProgressIndicator(), const SizedBox(height: 20), Text(logMessage)],
                    ))
                  : movies.isEmpty
                    ? Center(child: Padding(
                        padding: const EdgeInsets.all(20.0),
                        child: Text("FAILED:\n\$logMessage", textAlign: TextAlign.center, style: const TextStyle(color: Colors.red)),
                      ))
                    : ListView.builder(
                        itemCount: movies.length,
                        itemBuilder: (context, index) => ListTile(
                          leading: Image.network(movies[index]['small_cover_image']),
                          title: Text(movies[index]['title']),
                        ),
                      ),
              );
            }
          }
          EOF

      - name: 4. Build and Upload
        working-directory: ./cinemahub_flutter
        run: |
          flutter pub add http
          flutter build apk --release --no-tree-shake-icons

      - name: 5. Final Artifact
        uses: actions/upload-artifact@v4
        with:
          name: CinemaHub-Diagnostic-APK
          path: cinemahub_flutter/build/app/outputs/flutter-apk/app-release.apk
