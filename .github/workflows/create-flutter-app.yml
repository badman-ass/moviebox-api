name: CinemaHub V3 Final

on:
  workflow_dispatch:

permissions:
  contents: write

jobs:
  build:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout Repo
        uses: actions/checkout@v4

      - name: Setup Java
        uses: actions/setup-java@v4
        with:
          distribution: 'zulu'
          java-version: '17'

      - name: Setup Flutter
        uses: subosito/flutter-action@v2
        with:
          flutter-version: '3.19.0'

      - name: 1. Clean and Create
        run: |
          # Clean up any old folders to avoid "Exit code 1"
          rm -rf cinemahub_flutter
          flutter create cinemahub_flutter --project-name cinemahub --org com.cinemahub

      - name: 2. Unlock Internet (The Black Screen Fix)
        run: |
          # This command is safer and won't cause "Exit code 1"
          cd cinemahub_flutter/android/app/src/main
          sed -i '/<application/i \    <uses-permission android:name="android.permission.INTERNET" />' AndroidManifest.xml

      - name: 3. Install Movie Library
        working-directory: ./cinemahub_flutter
        run: flutter pub add http

      - name: 4. Apply Final Movie Logic
        run: |
          cat <<EOF > cinemahub_flutter/lib/main.dart
          import 'package:flutter/material.dart';
          import 'dart:convert';
          import 'package:http/http.dart' as http;

          void main() => runApp(MaterialApp(
            debugShowCheckedModeBanner: false,
            theme: ThemeData.dark(),
            home: const MovieListScreen(),
          ));

          class MovieListScreen extends StatefulWidget {
            const MovieListScreen({super.key});
            @override
            State<MovieListScreen> createState() => _MovieListScreenState();
          }

          class _MovieListScreenState extends State<MovieListScreen> {
            List movies = [];
            bool isLoading = true;
            String status = "Loading Movies...";

            @override
            void initState() {
              super.initState();
              fetchMovies();
            }

            Future<void> fetchMovies() async {
              try {
                // Using a 'User-Agent' makes the server think we are a browser
                final response = await http.get(
                  Uri.parse("https://yts.mx/api/v2/list_movies.json?limit=20"),
                  headers: {"User-Agent": "Mozilla/5.0"}
                );
                
                if (response.statusCode == 200) {
                  final data = json.decode(response.body);
                  setState(() {
                    movies = data['data']['movies'] ?? [];
                    isLoading = false;
                  });
                } else {
                  setState(() {
                    status = "Error: \${response.statusCode}";
                    isLoading = false;
                  });
                }
              } catch (e) {
                setState(() {
                  status = "Connection Failed. Please check internet.";
                  isLoading = false;
                });
              }
            }

            @override
            Widget build(BuildContext context) {
              return Scaffold(
                backgroundColor: const Color(0xFF1A1A1A),
                appBar: AppBar(title: const Text('CinemaHub V3'), backgroundColor: Colors.red[900]),
                body: isLoading 
                  ? Center(child: Column(
                      mainAxisAlignment: MainAxisAlignment.center,
                      children: [
                        const CircularProgressIndicator(color: Colors.red),
                        const SizedBox(height: 20),
                        Text(status)
                      ],
                    ))
                  : GridView.builder(
                      padding: const EdgeInsets.all(10),
                      gridDelegate: const SliverGridDelegateWithFixedCrossAxisCount(
                        crossAxisCount: 2, childAspectRatio: 0.7, crossAxisSpacing: 10, mainAxisSpacing: 10,
                      ),
                      itemCount: movies.length,
                      itemBuilder: (context, index) {
                        return Column(
                          children: [
                            Expanded(child: ClipRRect(
                              borderRadius: BorderRadius.circular(10),
                              child: Image.network(movies[index]['medium_cover_image'], fit: BoxFit.cover),
                            )),
                            const SizedBox(height: 5),
                            Text(movies[index]['title'], maxLines: 1, overflow: TextOverflow.ellipsis),
                          ],
                        );
                      },
                    ),
              );
            }
          }
          EOF

      - name: 5. Build Final APK
        working-directory: ./cinemahub_flutter
        run: flutter build apk --release --no-tree-shake-icons

      - name: 6. Upload Working APK
        uses: actions/upload-artifact@v4
        with:
          name: CinemaHub-V3-Working
          path: cinemahub_flutter/build/app/outputs/flutter-apk/app-release.apk
          
