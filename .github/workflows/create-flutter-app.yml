name: CinemaHub Final Build

on:
  workflow_dispatch:

permissions:
  contents: write

jobs:
  build:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout Repo
        uses: actions/checkout@v4

      - name: Setup Java
        uses: actions/setup-java@v4
        with:
          distribution: 'zulu'
          java-version: '17'

      - name: Setup Flutter
        uses: subosito/flutter-action@v2
        with:
          flutter-version: '3.19.0'

      - name: 1. Generate App Skeleton
        run: |
          # This creates the hidden Android folders that were missing before
          flutter create cinemahub_flutter --project-name cinemahub --org com.cinemahub

      - name: 2. Fix Internet Permission (Fixes Black Screen)
        run: |
          # This adds the permission so the app can actually talk to the internet
          sed -i '/<application/i \    <uses-permission android:name="android.permission.INTERNET" />' cinemahub_flutter/android/app/src/main/AndroidManifest.xml

      - name: 3. Add Movie App Logic
        run: |
          # We overwrite the default app with your Movie UI
          cat <<EOF > cinemahub_flutter/lib/main.dart
          import 'package:flutter/material.dart';
          import 'dart:convert';
          import 'package:http/http.dart' as http;

          void main() => runApp(const MyApp());

          class MyApp extends StatelessWidget {
            const MyApp({super.key});
            @override
            Widget build(BuildContext context) {
              return MaterialApp(
                debugShowCheckedModeBanner: false,
                theme: ThemeData.dark(),
                home: const MovieListScreen(),
              );
            }
          }

          class MovieListScreen extends StatefulWidget {
            const MovieListScreen({super.key});
            @override
            State<MovieListScreen> createState() => _MovieListScreenState();
          }

          class _MovieListScreenState extends State<MovieListScreen> {
            List movies = [];
            bool isLoading = true;

            @override
            void initState() {
              super.initState();
              fetchMovies();
            }

            Future<void> fetchMovies() async {
              try {
                final response = await http.get(Uri.parse("https://yts.mx/api/v2/list_movies.json"));
                if (response.statusCode == 200) {
                  final data = json.decode(response.body);
                  setState(() {
                    movies = data['data']['movies'] ?? [];
                    isLoading = false;
                  });
                }
              } catch (e) {
                setState(() => isLoading = false);
              }
            }

            @override
            Widget build(BuildContext context) {
              return Scaffold(
                backgroundColor: Colors.black,
                appBar: AppBar(
                  title: const Text('CinemaHub Live'),
                  backgroundColor: Colors.redAccent,
                ),
                body: isLoading
                    ? const Center(child: CircularProgressIndicator(color: Colors.red))
                    : GridView.builder(
                        padding: const EdgeInsets.all(10),
                        gridDelegate: const SliverGridDelegateWithFixedCrossAxisCount(
                          crossAxisCount: 2,
                          childAspectRatio: 0.7,
                          crossAxisSpacing: 10,
                          mainAxisSpacing: 10,
                        ),
                        itemCount: movies.length,
                        itemBuilder: (context, index) {
                          return ClipRRect(
                            borderRadius: BorderRadius.circular(8),
                            child: Stack(
                              fit: StackFit.expand,
                              children: [
                                Image.network(movies[index]['medium_cover_image'], fit: BoxFit.cover),
                                Positioned(
                                  bottom: 0,
                                  left: 0,
                                  right: 0,
                                  child: Container(
                                    color: Colors.black54,
                                    padding: const EdgeInsets.all(5),
                                    child: Text(
                                      movies[index]['title'],
                                      style: const TextStyle(fontSize: 12),
                                      maxLines: 1,
                                      overflow: TextOverflow.ellipsis,
                                    ),
                                  ),
                                )
                              ],
                            ),
                          );
                        },
                      ),
              );
            }
          }
          EOF

      - name: 4. Build APK
        working-directory: ./cinemahub_flutter
        run: |
          flutter pub add http
          flutter build apk --release --no-tree-shake-icons

      - name: 5. Upload Fixed APK
        uses: actions/upload-artifact@v4
        with:
          name: cinemahub-fixed-apk
          path: cinemahub_flutter/build/app/outputs/flutter-apk/app-release.apk
          
